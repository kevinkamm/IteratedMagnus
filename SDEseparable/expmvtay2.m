function [w,m,s,np] = expmvtay2(A,v,m,prec)
% [w,m,s,np] = expmvtay2(A,v,m)
% Compute the action of the matrix exponential of A on a vector v by means 
% of the Taylor approximation without explicitely computing exp(A).
% One term is considered in the absolute backward error estimation.

% Input data:
% - A:    Matrix to compute exp(A).
% - v:    Vector to compute exp(A)*v.
% - m:    Miminum approximation polynomial order chosen.  
% 
% Output data:
% - w:    Vector with the action of the matrix exponential of A on the 
%         vector v.
% - m:    Approximation polynomial order chosen. 
% - s:    Scaling parameter.
% - npmv: Number of matrix-vector products required.

tol=eps/2;
switch prec
    case 'double', tol = 2^(-53)/2;
    case 'single', tol = 2^(-24)/2;
    case 'half',   tol = 2^(-10)/2;
end
smax=45; 
mmax=60; 
p=[1, 1, 2, 6, 24, 120, 720, 5040, 40320, 362880, 3628800, 39916800, 479001600, 6227020800, 87178291200, 1307674368000, 20922789888000, 355687428096000, 6402373705728000, 121645100408832000, 2432902008176640000, 51090942171709440000, 1124000727777607680000, 25852016738884978212864, 620448401733239409999872, 15511210043330986055303168, 403291461126605650322784256, 10888869450418351940239884288, 304888344611713836734530715648, 8841761993739700772720181510144, 265252859812191032188804700045312, 8222838654177922430198509928972288, 263130836933693517766352317727113216, 8683317618811885938715673895318323200, 295232799039604119555149671006000381952, 10333147966386144222209170348167175077888, 371993326789901177492420297158468206329856, 13763753091226343102992036262845720547033088, 523022617466601037913697377988137380787257344, 20397882081197441587828472941238084160318341120, 815915283247897683795548521301193790359984930816, 33452526613163802763987613764361857922667238129664, 1405006117752879788779635797590784832178972610527232, 60415263063373834074440829285578945930237590418489344, 2658271574788448529134213028096241889243150262529425408, 119622220865480188574992723157469373503186265858579103744, 5502622159812088456668950435842974564586819473162983440384, 258623241511168177673491006652997026552325199826237836492800, 12413915592536072528327568319343857274511609591659416151654400, 608281864034267522488601608116731623168777542102418391010639872, 30414093201713375576366966406747986832057064836514787179557289984, 1551118753287382189470754582685817365323346291853046617899802820608, 80658175170943876845634591553351679477960544579306048386139594686464, 4274883284060025484791254765342395718256495012315011061486797910441984, 230843697339241379243718839060267085502544784965628964557765331531071488, 12696403353658276446882823840816011312245221598828319560272916152712167424, 710998587804863481025438135085696633485732409534385895375283304551881375744, 40526919504877220527556156789809444757511993541235911846782577699372834750464, 2350561331282878906297796280456247634956966273955390268712005058924708557225984, 138683118545689864933221185143853352853533809868133429504739525869642019130834944, 8320987112741391580056396102959641077457945541076708813599085350531187384917164032, 507580213877224835833540161373088490724281389843871724559898414118829028410677788672, 31469973260387939390320343330721249710233204778005956144519390914718240063804258910208, 1982608315404440084965732774767545707658109829136018902789196017241837351744329178152960, 126886932185884165437806897585122925290119029064705209778508545103477590511637067401789440, 8247650592082471516735380327295020523842257210146637473076098881993433291790288339528056832, 544344939077443069445496060275635856761283034568718387417404234993819829995466026946857533440, 36471110918188683221214362054827498508015278133658067038296405766134083781086959639263732301824, 2480035542436830547970901153987107983847555399761061789915503815309070879417337773547217359994880, 171122452428141297375735434272073448876652721480628511030304905066123383956194496253690059725733888, 11978571669969890269925854460558840225267029209529303278944419871214396524861374498691473966836482048, 850478588567862176139364498862283450363106657876759119884137546969850291984346623845721803156845756416];

V(:,1)=A*v;
npmv=1;
for j=2:m+1
	V(:,j)=A*V(:,j-1);
    npmv=npmv+1;
end
s=ceil((norm(V(:,m+1),1)/(p(m+2)*tol))^(1/(m+1)));
np=m*s;
f=0;
while f==0 && m<mmax
    m=m+1;
	V(:,m+1)=A*V(:,m);
    npmv=npmv+1;
    s1=ceil((norm(V(:,m+1),1)/(p(m+2)*tol))^(1/(m+1)));
    np1=m*s1;
    if np1<=np
        np=np1;
        s=s1;
    else
        f=1;
        m=m-1;
    end
end
s=min(s,smax);
np=m*s;

w=v/p(1);
for j=1:m
    w=w+V(:,j)/(p(j+1)*s^j);
end
A=A.*(1/s);
for i=2:s
    v=w;
    w=v/p(1);
    for j=1:m
        v=A*v;
        npmv=npmv+1;
        w=w+v/p(j+1);
    end
end
end
